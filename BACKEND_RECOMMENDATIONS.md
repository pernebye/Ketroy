# Рекомендации по доработке бэкенда для автоматического применения промокодов

## Обзор

Реализована полная механика автоматического применения промокодов из реферальных ссылок в мобильном приложении. Для корректной работы требуется доработка на стороне бэкенда.

## Текущая реализация в мобильном приложении

### Что уже работает:

1. **Сохранение промокода из deep link**
   - При переходе по ссылке `https://app.ketroy-shop.kz/invite?ref=PROMOCODE` промокод автоматически сохраняется в локальное хранилище
   - Промокод сохраняется даже если приложение не установлено (после установки из App Store он будет доступен)

2. **Автоматическое применение при регистрации**
   - При первой регистрации пользователя сохраненный промокод автоматически применяется
   - Промокод применяется после успешной регистрации, но до завершения процесса

3. **Автоматическое применение при авторизации**
   - При авторизации существующего пользователя проверяется, был ли уже применен промокод
   - Если промокод еще не был применен (`used_promo_code = 0` или `null`), он автоматически применяется
   - Если промокод уже был применен, новый промокод не применяется (сохраняется старый)

4. **Очистка после применения**
   - После успешного применения промокод удаляется из локального хранилища
   - Это предотвращает повторное применение

## Требования к бэкенду

### 1. API Endpoint: `/promo-codes/apply`

**Текущий endpoint должен:**

- ✅ Принимать `promo_code` в теле запроса
- ✅ Требовать авторизацию (token)
- ✅ Возвращать сообщение об успехе/ошибке

**Дополнительные требования:**

1. **Проверка на повторное применение:**
   - Если у пользователя уже есть `used_promo_code = true` (или `used_promo_code > 0`), возвращать ошибку:
     ```json
     {
       "message": "Промокод уже был применен ранее"
     }
     ```
   - Или можно разрешить применение, но это зависит от бизнес-логики

2. **Валидация промокода:**
   - Проверять существование промокода
   - Проверять активность промокода
   - Проверять срок действия промокода (если есть)

3. **Обновление данных пользователя:**
   - После успешного применения обновлять поле `used_promo_code` в таблице пользователей
   - Обновлять поле `referrer_id` (ID пользователя, который поделился промокодом)
   - Применять скидку/бонусы согласно настройкам реферальной программы

### 2. API Endpoint: `/auth/register` (или аналогичный)

**Текущий endpoint должен:**

- ✅ Создавать нового пользователя
- ✅ Возвращать токен и данные пользователя

**Дополнительные требования:**

- Поле `used_promo_code` должно быть `false` (или `0`) по умолчанию для новых пользователей
- Это позволит мобильному приложению определить, можно ли применять промокод

### 3. API Endpoint: `/auth/login` (или `/auth/verify-sms`)

**Текущий endpoint должен:**

- ✅ Возвращать данные пользователя, включая поле `used_promo_code`

**Важно:**

- Поле `used_promo_code` должно быть в ответе, чтобы мобильное приложение могло проверить, был ли уже применен промокод

### 4. API Endpoint: `/referral/info` (или аналогичный)

**Текущий endpoint возвращает:**

```json
{
  "is_available": true,
  "promo_code": "F9A91458",
  "share_url": "https://app.ketroy-shop.kz/invite?ref=F9A91458",
  "has_used_promo_code": false,
  "referrer_bonus_percent": 2,
  "referrer_max_purchases": 3,
  "new_user_discount_percent": 10,
  "new_user_bonus_percent": 5,
  "total_referred": 0,
  "description": "..."
}
```

**Этот endpoint уже работает корректно**, но важно убедиться, что:
- `has_used_promo_code` корректно отражает состояние пользователя
- Поле синхронизировано с `used_promo_code` в таблице пользователей

## Сценарии работы

### Сценарий 1: Новый пользователь, приложение не установлено

1. Пользователь переходит по ссылке `https://app.ketroy-shop.kz/invite?ref=F9A91458`
2. Открывается App Store / Play Store
3. Пользователь устанавливает приложение
4. При первом запуске приложение получает initial link через deep linking
5. Промокод `F9A91458` сохраняется в локальное хранилище
6. Пользователь регистрируется
7. После успешной регистрации промокод автоматически применяется
8. Промокод удаляется из локального хранилища

**Требования к бэкенду:**
- Deep linking должен быть настроен на сервере (Universal Links для iOS, App Links для Android)
- Endpoint `/promo-codes/apply` должен работать сразу после регистрации

### Сценарий 2: Новый пользователь, приложение установлено

1. Пользователь переходит по ссылке `https://app.ketroy-shop.kz/invite?ref=F9A91458`
2. Приложение открывается (или запускается)
3. Промокод `F9A91458` сохраняется в локальное хранилище
4. Пользователь регистрируется
5. После успешной регистрации промокод автоматически применяется
6. Промокод удаляется из локального хранилища

**Требования к бэкенду:**
- То же, что в сценарии 1

### Сценарий 3: Существующий пользователь без примененного промокода

1. Пользователь переходит по ссылке `https://app.ketroy-shop.kz/invite?ref=F9A91458`
2. Приложение открывается
3. Промокод `F9A91458` сохраняется в локальное хранилище
4. Пользователь авторизуется
5. Приложение проверяет `used_promo_code` в данных пользователя
6. Если `used_promo_code = false` (или `0`), промокод автоматически применяется
7. Промокод удаляется из локального хранилища

**Требования к бэкенду:**
- Endpoint авторизации должен возвращать `used_promo_code`
- Endpoint `/promo-codes/apply` должен работать для авторизованных пользователей

### Сценарий 4: Существующий пользователь с примененным промокодом

1. Пользователь переходит по ссылке `https://app.ketroy-shop.kz/invite?ref=NEWCODE`
2. Приложение открывается
3. Промокод `NEWCODE` сохраняется в локальное хранилище
4. Пользователь авторизуется
5. Приложение проверяет `used_promo_code` в данных пользователя
6. Если `used_promo_code = true` (или `> 0`), промокод НЕ применяется
7. Промокод удаляется из локального хранилища (чтобы не пытаться применять снова)

**Требования к бэкенду:**
- Endpoint авторизации должен возвращать актуальное значение `used_promo_code`
- Endpoint `/promo-codes/apply` должен возвращать ошибку, если промокод уже был применен (опционально, для защиты)

## Проверка реализации

### Тестовые случаи:

1. ✅ Регистрация нового пользователя с промокодом из deep link
2. ✅ Авторизация существующего пользователя без примененного промокода с промокодом из deep link
3. ✅ Авторизация существующего пользователя с примененным промокодом (новый промокод не должен применяться)
4. ✅ Установка приложения из App Store после перехода по ссылке (промокод должен сохраниться)

### Что проверить на бэкенде:

1. **Поле `used_promo_code` в таблице пользователей:**
   - Должно быть `false` (или `0`) для новых пользователей
   - Должно обновляться на `true` (или `1`) после применения промокода
   - Должно возвращаться в ответах API авторизации и профиля

2. **Endpoint `/promo-codes/apply`:**
   - Должен проверять, не был ли промокод уже применен
   - Должен обновлять `used_promo_code` и `referrer_id`
   - Должен применять скидку/бонусы согласно настройкам

3. **Deep Linking:**
   - Universal Links (iOS) должны быть настроены для домена `app.ketroy-shop.kz`
   - App Links (Android) должны быть настроены для домена `app.ketroy-shop.kz`
   - При переходе по ссылке должна быть возможность открыть приложение или перейти в магазин

## Дополнительные рекомендации

1. **Логирование:**
   - Логировать все применения промокодов
   - Логировать попытки повторного применения
   - Это поможет в отладке и аналитике

2. **Защита от злоупотреблений:**
   - Ограничить количество применений одного промокода (если нужно)
   - Проверять валидность промокода перед применением
   - Проверять срок действия промокода

3. **Аналитика:**
   - Отслеживать количество применений промокодов
   - Отслеживать эффективность реферальной программы
   - Отслеживать источники переходов (deep links)

## Заключение

Мобильное приложение полностью готово к работе с автоматическим применением промокодов. Требуется только убедиться, что бэкенд корректно обрабатывает все сценарии и возвращает необходимые данные.

